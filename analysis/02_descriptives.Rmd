---
title: "2_descriptives"
author: "Milena Costa"
date: "2025-11-04"
output: pdf_document
---


```{r setup, include=FALSE}

source(here::here("scripts","_common.R"), local = knitr::knit_global())

df_wide <- readRDS(here::here("data","processed","df_wide.rds"))
df_long <- readRDS(here::here("data","processed","df_long.rds"))


```

# 1) Helper functions

```{r}
# Standard error

# Color palettes consistent across plots

pal_target <- c(
"self"      = "#E15759",
"climate"   = "#59A14F",
"prosocial" = "#4E79A7"
)

pal_group <- c(
"control"       = "#4E79A7",
"positive_norm" = "#59A14F",
"negative_norm" = "#E15759"
)



pd <- position_dodge(width = 0.7)


```

# 2) Participant-Level Summaries

```{r}

participant_summary <- df_wide |>
summarise(
N = n(),
N_classes = n_distinct(class),
N_schools = n_distinct(school)
)

participant_summary

```

# 3) Moderators
## Susceptibility

```{r}

susceptibility_descriptives <- df_long |>
summarise(
M   = mean(susceptibility, na.rm = TRUE),
SD  = sd(susceptibility, na.rm = TRUE),
Min = min(susceptibility, na.rm = TRUE),
Max = max(susceptibility, na.rm = TRUE)
)

susceptibility_descriptives

```

## Classroom Cohesion



# 4) Manipulation Condition Counts


```{r}
condition_summary <- df_wide |>
group_by(school, group) |>
summarise(n = n(), .groups = "drop") |>
tidyr::pivot_wider(names_from = group, values_from = n, values_fill = 0)

condition_summary

```


# 5) Choice Summaries

a) Per-participant (ppn) proportions

```{r}

summary_ppn <- df_long |>
group_by(ppn, target, block, group) |>
summarise(prop_per_ppn = mean(choice, na.rm = TRUE), .groups = "drop")

summary_ppn

```

b) Group-level summary (Target $\times$ Block $\times$ Group)

```{r}

choice_summary <- summary_ppn |>
  group_by(target, block, group) |>
  summarise(
    n  = n(),
    M  = mean(prop_per_ppn, na.rm = TRUE),
    SE = se(prop_per_ppn),
    .groups = "drop"
  )

choice_summary

```

c) Reward $\times$ Effort summary (across participants)

```{r}

choice_by_params <- df_long |>
  group_by(ppn, reward, effort) |>
  summarise(prop_per_ppn = mean(choice, na.rm = TRUE), .groups = "drop") |>
  group_by(reward, effort) |>
  summarise(
    n  = n(),
    M  = mean(prop_per_ppn),
    SE = se(prop_per_ppn),
    .groups = "drop"
  )

choice_by_params
```

# Visualizations

a) Reward $\times$ Effort interaction

```{r}

plot_a_data <- df_long |> 
  group_by(reward, effort) |> 
  summarise(p = mean(choice == 1, na.rm = TRUE), .groups = "drop")


reward_effort_plot <- reward_effort_summary |>
  ggplot(aes(x = reward, y = p, color = effort, group = effort)) +
  geom_point(size = 3) +
  geom_line(size = 1) +
  scale_color_manual(values = c(
    "40%" = "#E15759",
    "90%" = "#4E79A7"
  )) +
  labs(
    x = "Reward",
    y = "Proportion of High-Effort Choices",
    color = "Effort"
  ) +
  theme_bw()



ggsave("figures/descriptives/reward_effort_plot.png",  
       plot = reward_effort_plot,
       width = 7, height = 5, dpi = 300)


```


b) Target $\times$ Block $\times$ Group

```{r}

plot_b_data <- df_long |>
  group_by(group, block, target) |>
  summarise(
    p_choice = mean(choice == 1, na.rm = TRUE),
    n       = sum(!is.na(choice)),
    .groups = "drop"
  )


target_block_group_plot <- ggplot(plot_b_data,
       aes(x = block,
           y = p_choice,
           color = target,
           group = target)) +
  geom_point(size = 3) +
  geom_line(size = 1) +
  facet_wrap(~ group, labeller = labeller(group = group_labels)) +
  labs(
    x     = "Block",
    y     = "Proportion of High-Effort Choices",
    color = "Target"
  ) +
  scale_color_manual(values = pal_target) +
  theme_bw() +
  theme(
    legend.position = "top",
    legend.title    = element_blank()
  )

ggsave("figures/descriptives/target_block_group_plot.png",  
       plot = target_block_group_plot,
       width = 7, height = 5, dpi = 300)

```




