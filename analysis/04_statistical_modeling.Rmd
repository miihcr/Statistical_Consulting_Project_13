---
title: "3_analysis"
author: "Milena Costa"
date: "2025-11-03"
output: pdf_document
---

```{r setup, include=FALSE}

source(here::here("scripts","_common.R"), local = knitr::knit_global())

df_wide <- readRDS(here::here("data","processed","df_wide.rds"))
df_long <- readRDS(here::here("data","processed","df_long.rds"))

df_long <- df_long |>
  mutate(
    group  = relevel(group,  ref = "control"),
    target = relevel(target, ref = "self"),
    effort = relevel(effort, ref = "40%"),
    block  = relevel(block,  ref = "pre")
  )

options(contrasts = c("contr.treatment", "contr.poly"))

ctrl <- glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e6))


```

# 1. Statistical Analysis

## Research Question 1 

Do exposure to social norms about environmental behavior influence children’s effortful pro-environmental choices?

```{r}

# Baseline model (intercept only)

m0 <- glmer(
  choice ~ 1 + (1 + block | ppn),  
  data = df_long, family = binomial, control = ctrl
)

# Step 1: Test whether classroom random intercept is needed

m1 <- glmer(
  choice ~ target*group*block + reward*effort + school +
    (1 | ppn) + (1 | class),
  data = df_long, family = binomial, control = ctrl
)

m1_simpler <- glmer(
  choice ~ target*group*block + reward*effort + school +
    (1 | ppn),
  data = df_long, family = binomial, control = ctrl
)

# Compare models
print(anova(m1_simpler, m1, test = "Chisq"))
print(isSingular(m1))
print(VarCorr(m1))



# Step 2: Add random slope for Block
m_full <- glmer(
  choice ~ target*group*block + reward*effort + school +
    (1 + block | ppn),
  data = df_long, family = binomial, control = ctrl
)

# Compare models

print(anova(m1_simpler, m_full, test = "Chisq")) # full model is better
isSingular(m_full)
print(VarCorr(m_full))


# Step 3: test the 3-way interaction

m_no_3way <- glmer(
  choice ~ target + group + block + 
    target:group + target:block + group:block +  # all 2-way interactions
    reward * effort + school +
    (1 + block | ppn),
  data = df_long, family = binomial, control = ctrl
)

anova(m_no_3way, m_full, test = "Chisq") # model without 3way is better but we retain full model given RQ1


# Choose final model 
final_model <- m_full

summary(final_model)
# Compare with a baseline model
anova(m0, final_model, test = "Chisq")




```


## Model Summary and Odds Ratios

```{r}


print(summary(final_model))

# Overall model fit

print(anova(m0, final_model, test = "Chisq"))

# Odds ratio with 95% CIs
se <- sqrt(diag(vcov(final_model)))

log_odds <- fixef(final_model)
tab <- data.frame(
  OR = exp(log_odds),
  se = se,
  LL = exp(log_odds - 1.96 * se),
  UL = exp(log_odds + 1.96 * se)
)
print(round(tab, 2))

round(data.frame(se),2)


 
coefs <- summary(final_model)$ coefficients[, "Estimate"]
std.err <- summary(final_model)$ coefficients[, "Std. Error"]
nams <- rownames(summary(final_model)$ coefficients)



```


## 2. Post-hoc Analyses 

### 1. Reward $\times$ Effort interaction


```{r}

# 1. EMM for all combinations of reward x effort

emm_re <- emmeans(final_model, ~ reward * effort, type = "response")


# 2. Pairwise comparisons 

# Reward effects within each effort level: Do high rewards increase choice probability equally at 40% and 90% effort?

contrast(emm_re, "pairwise", by = "effort", adjust = "holm")


# Effort effects within each reward level: Is 90% chosen less often than 40% at each reward magnitude?

contrast(emm_re, "pairwise", by = "reward", adjust = "holm")

# Visualization

emmip(final_model, effort ~ reward, CIs = TRUE, type = "response") +
  labs(title = "Predicted Probability of High-Effort Choice",
       y = "P(High-Effort Choice)",
       x = "Reward (points)")

```



### 2. Target $\times$ Group interaction


```{r}

# 1. EMM for all combinations of target x group

emm_tg <- emmeans(final_model, ~ target * group, type = "response")



# 2. Pairwise comparisons 


# Target differences within each group: Do groups differ in how they respond to Self vs Climate vs Prosocial cues?


contrast(emm_tg, "pairwise", by = "group", adjust = "holm")
  
  
# Group differences within each target: Do the norm groups differ in climate choices overall (pre+post averaged)?

contrast(emm_tg, "pairwise", by = "target", adjust = "holm")

# Visualization

emmip(emm_tg, group ~ target, CIs = TRUE, type = "response") +
  labs(title = "Predicted Probability of High-Effort Choice",
       y = "P(High-Effort Choice)",
       x = "Social Target")


```


### 3. Block × Group × Target: Difference-in-Differences Analysis

```{r}

# EMM for the full 3 way interaction
emm_tgb <- emmeans(m_full, ~ target * group * block, type = "response")

emm_tgb

# Pre-to-Post changes within each target × group combination

prepost_tgb <- contrast(emm_tgb, method="revpairwise", by = c("target","group"),
                        type = "response")
# Difference-in-Differences: Compare pre-post changes across groups for each target


did_by_target <- contrast(
  emm_tgb,
  interaction = c("pairwise", "revpairwise"),  # group pairwise, block revpairwise
  by = "target",
  adjust = "holm",
  type = "response"
)

print(did_by_target)

# Visualization
emmip(final_model, group ~ block | target, type = "response", CIs = TRUE) +
  labs(title = "Predicted Probability of High-Effort Choice",
       y = "P(High-Effort Choice)",
       x = "Block") 


# Create a summary of the DID analysis for easy reporting
did_summary <- as.data.frame(did_by_target)
print(did_summary)

```

### Diagnostics (final_model)

```{r}

# 1. Simulate DHARMa residuals

sim <- simulateResiduals(
  fittedModel = final_model,
  n = 1000,
  plot = FALSE
)


# 2. Main diagnostic plots

plot(sim) # QQ + residuals vs fitted

plotQQunif(sim)  # QQ only
plotResiduals(sim) # residuals vs predicted only

# 3. Global statistical tests

testUniformity(sim)      # Should be non-significant
testDispersion(sim)      # Should be non-significant
testOutliers(sim)       # OK if significant for GLMMs, consider type="bootstrap" if significant

# 4. Predictor-specific residual checks

mf <- model.frame(final_model) # because of NA values 


plotResiduals(sim, mf$target)
plotResiduals(sim, mf$group)
plotResiduals(sim, mf$block)
plotResiduals(sim, mf$school)
plotResiduals(sim, mf$reward)
plotResiduals(sim, mf$effort)


# 5. Grouped residuals (random-effects diagnostic)
sim_ppn <- recalculateResiduals(sim, group = mf$ppn)
plot(sim_ppn)
testDispersion(sim_ppn)


performance::icc(final_model)

performance::r2(final_model)

r2_nakagawa(final_model)

```

## Research Question 2: Moderation Analysis

Are these effects moderated by (a) individual social susceptibility and (b) classroom cohesion?

### Social Susceptibility Moderation

```{r}

# 1. Test whether susceptibility moderates the Group×Block×Target interaction

m_suscept_full <- glmmTMB(
  choice ~ group * block * target * susceptibility_c + 
           reward * effort + school +
    (1 + block | ppn),
  data = df_long, 
  family = binomial
)

summary(m_suscept_full)

# 2, Compare models 

# Model without four-way interaction (all three-ways included)
m_suscept_3way <- glmmTMB(
  choice ~ (group * block * target) + (group * block * susceptibility_c) +
           (group * target * susceptibility_c) + (block * target * susceptibility_c) +
           reward * effort + school +
    (1 + block | ppn),
  data = df_long, 
  family = binomial
)

# Model with only susceptibility × group × block 
m_suscept_simpler <- glmmTMB(
  choice ~ group * block * susceptibility_c + target + 
           target:group + target:block +  # Allow target effects but not moderated by susceptibility
           reward * effort + school +
    (1 + block | ppn),
  data = df_long, 
  family = binomial
)

# Base model: susceptibility main effect only
m_suscept_base <- glmmTMB(
  choice ~ group * block * target + susceptibility_c + 
           reward * effort + school +
    (1 + block | ppn),
  data = df_long, 
  family = binomial
)

# Compare models
print(anova(m_suscept_base, m_suscept_simpler, m_suscept_3way, m_suscept_full, test = "Chisq"))


```


### Classroom Cohesion Moderation

Since cohesion is aggregated, we need the random intercept for class in these models

```{r}

# Full model with four-way interaction + class random effect
m_cohesion_full_class <- glmmTMB(
  choice ~ group * block * target * cohesion_c + 
    reward * effort + school +
    (1 + block | ppn) + (1 | class),
  data = df_long, 
  family = binomial
)

# Check if class random effect is needed
m_cohesion_full_noclass <- glmmTMB(
  choice ~ group * block * target * cohesion_c + 
    reward * effort + school +
    (1 + block | ppn),
  data = df_long, 
  family = binomial
)

print(anova(m_cohesion_full_noclass, m_cohesion_full_class, test = "Chisq"))


# Model with only cohesion × group × block
m_cohesion_simpler_class <- glmmTMB(
  choice ~ group * block * cohesion_c + target + 
    target:group + target:block +
    reward * effort + school +
    (1 + block | ppn) + (1 | class),
  data = df_long, 
  family = binomial
)

# Base model: cohesion main effect only
m_cohesion_base_class <- glmmTMB(
  choice ~ group * block * target + cohesion_c + 
    reward * effort + school +
    (1 + block | ppn) + (1 | class),
  data = df_long, 
  family = binomial
)

# Compare models

print(anova(m_cohesion_base_class, 
            m_cohesion_simpler_class, 
            m_cohesion_full_class, test = "Chisq"))

  
```

Note: I'm still gonna add the rest of the analysis