plotResiduals(res, form = mf$block,  main = "Residuals vs block")
plotResiduals(res, form = mf$reward, main = "Residuals vs reward")
plotResiduals(res, form = mf$effort, main = "Residuals vs effort")
plotResiduals(res, form = mf$school, main = "Residuals vs school")
# Residuals vs participant (random effect grouping factor)
plotResiduals(res, form = mf$ppn, main = "Residuals vs participant (ppn)")
susceptibility_descriptives
participant_summary
# Load processed data written by 1_dataprep
df_wide <- readRDS(here::here("data","processed","df_wide.rds"))
df_long <- readRDS(here::here("data","processed","df_long.rds"))
participant_summary <- df_wide |>
summarise(
N = n(),
N_classes = n_distinct(class),
N_schools = n_distinct(school)
)
participant_summary
# Social susceptibility
susceptibility_descriptives <- df_long |>
summarise(
M = mean(susceptibility, na.rm = TRUE),
SD = sd(susceptibility, na.rm = TRUE),
Min = min(susceptibility, na.rm = TRUE),
Max = max(susceptibility, na.rm = TRUE)
)
susceptibility_descriptives
# --- Sample by condition  ---
condition_summary <- df_wide |>
group_by(school, group) |>
summarise(n = n(), .groups = "drop") |>
pivot_wider(names_from = group, values_from = n, values_fill = 0)
# Overall high-effort choice rate
overall_choice <- mean(df_long$choice, na.rm = TRUE)
print(condition_summary)
# --- Choice frequencies ---
choice_summary <- df_long |>
group_by(ppn, target, block, group) |>
summarise(prop_per_ppn = mean(choice, na.rm = TRUE), .groups = "drop") |>
group_by(target, block, group) |>
summarise(
n_participants = n(),
prop_high_effort = mean(prop_per_ppn, na.rm = TRUE),
se = sd(prop_per_ppn) / sqrt(n()),  # Proper SE
.groups = "drop"
) |>
arrange(target, group, block)
print(choice_summary, n = 100)
# --- By reward and effort ---
choice_by_params <- df_long |>
group_by(ppn, reward, effort) |>
summarise(prop_per_ppn = mean(choice, na.rm = TRUE), .groups = "drop") |>
group_by(reward, effort) |>
summarise(
n_participants = n(),
prop_high_effort = mean(prop_per_ppn),
se = sd(prop_per_ppn) / sqrt(n()),
.groups = "drop"
)
print(choice_by_params)
# --- Choice frequencies ---
choice_summary <- df_long |>
group_by(ppn, target, block, group) |>
summarise(prop_per_ppn = mean(choice, na.rm = TRUE), .groups = "drop") |>
group_by(target, block, group) |>
summarise(
n_participants = n(),
prop_high_effort = mean(prop_per_ppn, na.rm = TRUE),
se = sd(prop_per_ppn, na.rm = TRUE) / sqrt(n()),  # Proper SE
.groups = "drop"
) |>
arrange(target, group, block)
print(choice_summary, n = 100)
participant_summary <- df_wide |>
summarise(
N = n(),
N_classes = n_distinct(class),
N_schools = n_distinct(school)
)
participant_summary
# Social susceptibility
susceptibility_descriptives <- df_long |>
summarise(
M = mean(susceptibility, na.rm = TRUE),
SD = sd(susceptibility, na.rm = TRUE),
Min = min(susceptibility, na.rm = TRUE),
Max = max(susceptibility, na.rm = TRUE)
)
susceptibility_descriptives
# --- Sample by condition  ---
condition_summary <- df_wide |>
group_by(school, group) |>
summarise(n = n(), .groups = "drop") |>
pivot_wider(names_from = group, values_from = n, values_fill = 0)
# Overall high-effort choice rate
overall_choice <- mean(df_long$choice, na.rm = TRUE)
print(condition_summary)
# --- Choice frequencies ---
choice_summary <- df_long |>
group_by(ppn, target, block, group) |>
summarise(prop_per_ppn = mean(choice, na.rm = TRUE), .groups = "drop") |>
group_by(target, block, group) |>
summarise(
n_participants = n(),
prop_high_effort = mean(prop_per_ppn, na.rm = TRUE),
se = sd(prop_per_ppn, na.rm = TRUE) / sqrt(n()),  # Proper SE
.groups = "drop"
) |>
arrange(target, group, block)
print(choice_summary, n = 100)
# --- By reward and effort ---
choice_by_params <- df_long |>
group_by(ppn, reward, effort) |>
summarise(prop_per_ppn = mean(choice, na.rm = TRUE), .groups = "drop") |>
group_by(reward, effort) |>
summarise(
n_participants = n(),
prop_high_effort = mean(prop_per_ppn),
se = sd(prop_per_ppn) / sqrt(n()),
.groups = "drop"
)
print(choice_by_params)
# --- Visualizations ---
df_summary <- df_long
pd <- position_dodge(width = 0.75)
# --- Plot A: Proportion by Target ---
a_data <- df_long |>
group_by(ppn, target) |>
summarise(prop_per_ppn = mean(choice, na.rm = TRUE), .groups = "drop") |>
group_by(target) |>
summarise(
prop = mean(prop_per_ppn),
se = sd(prop_per_ppn) / sqrt(n()),
n = n(),
.groups = "drop"
)
plot_a <- ggplot(a_data,
aes(x = reorder(target, -prop),
y = prop,
fill = target)) +
geom_bar(stat = "identity", width = 0.6) +
geom_errorbar(aes(ymin = prop - se, ymax = prop + se),
width = 0.15, linewidth = 0.8) +
geom_text(aes(label = scales::percent(prop, accuracy = 1)),
vjust = -1, size = 4) +
scale_fill_manual(
name = "Social target",
values = c("self" = "#E15759",
"climate" = "#59A14F",
"prosocial" = "#4E79A7")
) +
scale_y_continuous(labels = scales::percent_format(accuracy = 1),
limits = c(0, 1),
expand = expansion(mult = c(0, 0.1))) +
labs(
x = "Recipient",
y = "Proportion of High-Effort Choices",
fill = "Social target"
) +
theme_minimal(base_size = 12) +
theme(legend.position = "none",
panel.grid.major.x = element_blank())
plot_a
# --- Plot B: Proportion by Effort ---
b_data <- df_long |>
group_by(ppn, effort, target) |>
summarise(prop_per_ppn = mean(choice, na.rm = TRUE), .groups = "drop") |>
group_by(effort, target) |>
summarise(
prop = mean(prop_per_ppn),
se   = sd(prop_per_ppn) / sqrt(n()),
n    = n(),
.groups = "drop"
)
pd <- position_dodge(width = 0.75)
plot_b <- ggplot(b_data, aes(x = effort, y = prop, fill = target)) +
geom_col(position = pd, width = 0.7) +
geom_errorbar(aes(ymin = prop - se, ymax = prop + se),
position = pd, width = 0.2, linewidth = 0.6) +
scale_fill_manual(
values = c("self" = "#E15759",
"climate" = "#59A14F",
"prosocial" = "#4E79A7"),
name = "Recipient"
) +
scale_y_continuous(
labels = scales::percent_format(accuracy = 1),
limits = c(0, 1),
expand = c(0, 0)
) +
labs(x = "Effort Level",
y = "Proportion of High-Effort Choices") +
theme_classic(base_size = 12) +
theme(legend.position = "top",
legend.title = element_blank())
plot_b
# --- Plot C: proportion by reward
c_data <- df_long |>
group_by(ppn, reward, target) |>
summarise(prop_per_ppn = mean(choice, na.rm = TRUE), .groups = "drop") |>
group_by(reward, target) |>
summarise(
prop = mean(prop_per_ppn),
se = sd(prop_per_ppn) / sqrt(n()),
n = n(),
.groups = "drop"
)
plot_c <- ggplot(c_data, aes(x = reward, y = prop, fill = target)) +
geom_col(position = pd, width = 0.7) +
geom_errorbar(aes(ymin = prop - se, ymax = prop + se),
position = pd, width = 0.2, linewidth = 0.6) +
scale_fill_manual(
values = c("self" = "#E15759",
"climate" = "#59A14F",
"prosocial" = "#4E79A7"),
name = "Recipient"
) +
scale_y_continuous(labels = scales::percent_format(accuracy = 1),
limits = c(0, 1), expand = c(0, 0)) +
labs(x = "Reward",
y = "Proportion of High-Effort Choices") +
theme_classic(base_size = 12) +
theme(legend.position = "top",
legend.title = element_blank())
plot_c
# --- Interaction Plots ---
# --- Plot D: Reward x Effort interaction ---
d_data <- df_long |>
group_by(ppn, reward, effort) |>
summarise(prop_per_ppn = mean(choice, na.rm = TRUE), .groups = "drop") |>
group_by(reward, effort) |>
summarise(
prop = mean(prop_per_ppn),
se = sd(prop_per_ppn) / sqrt(n()),
n = n(),
.groups = "drop"
)
plot_d <- ggplot(d_data, aes(x = reward, y = prop,
color = effort, group = effort)) +
geom_point(size = 3.5) +
geom_line(linewidth = 1.1) +
geom_errorbar(aes(ymin = prop - se, ymax = prop + se),
width = 0.15, linewidth = 0.9) +
scale_color_tableau(palette = "Tableau 10", name = "Effort Level") +
scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0.5, 1, 0.1)) +
coord_cartesian(ylim = c(0.5, 1)) +
labs(
x = "Reward",
y = "Proportion High-Effort",
title = "Reward × Effort Interaction"
) +
theme_minimal(base_size = 12) +
theme(legend.position = "right",
panel.grid.minor = element_blank())
plot_d
# ---  Plot E: Target × Block × Group
e_data <- df_long |>
group_by(ppn, target, block, group) |>
summarise(prop_per_ppn = mean(choice, na.rm = TRUE), .groups = "drop") |>
group_by(target, block, group) |>
summarise(
n_participants = n(),
prop = mean(prop_per_ppn),
se = sd(prop_per_ppn) / sqrt(n()),
.groups = "drop"
)
plot_e <- ggplot(e_data,
aes(x = block, y = prop,
color = group, group = group)) +
geom_line(linewidth = 1.3) +
geom_point(size = 3.5) +
geom_errorbar(aes(ymin = prop - se, ymax = prop + se),
width = 0.1, linewidth = 0.9) +
facet_wrap(~ target, labeller = labeller(
target = c("self" = "Self",
"climate" = "Climate",
"prosocial" = "Prosocial")
)) +
scale_color_manual(
name = "Condition",
values = c(
"negative_norm" = "#E15759",
"positive_norm" = "#59A14F",
"control" = "#4E79A7"
),
labels = c(
"positive_norm" = "Positive Norm",
"negative_norm" = "Negative Norm",
"control" = "Control"
)
) +
scale_y_continuous(
labels = scales::percent_format(accuracy = 1),
limits = c(0.7, 1),
breaks = seq(0.7, 1, 0.05)
) +
labs(
x = NULL,
y = "Proportion High-Effort",
title = "Target × Block × Manipulation Condition"
) +
theme_minimal(base_size = 12) +
theme(
legend.position = "bottom",
strip.text = element_text(face = "bold", size = 12),
panel.grid.minor = element_blank()
)
plot_e
# --- Plot F: Focus on Climate Target Only ---
f_data <- e_data |>
filter(target == "climate")
plot_f <- ggplot(f_data,
aes(x = block, y = prop,
color = group, group = group)) +
geom_line(linewidth = 1.5) +
geom_point(size = 4) +
geom_errorbar(aes(ymin = prop - se, ymax = prop + se),
width = 0.1, linewidth = 1) +
scale_color_manual(
name = "Condition",
values = c(
"negative_norm" = "#E15759",
"positive_norm" = "#59A14F",
"control" = "#4E79A7"
),
labels = c(
"positive_norm" = "Positive Norm",
"negative_norm" = "Negative Norm",
"control" = "Control"
)
) +
scale_y_continuous(
labels = scales::percent_format(accuracy = 1),
limits = c(0.7, 1),
breaks = seq(0.7, 1, 0.05)
) +
labs(
x = NULL,
y = "Proportion High-Effort",
title = "Pre-Post Changes in Climate Target by Condition"
) +
theme_minimal(base_size = 13) +
theme(
legend.position = "bottom",
panel.grid.minor = element_blank()
)
plot_f
# Main effect plot
p_main <- ggplot(choice_summary, aes(x = block, y = prop_high_effort,
color = group, group = group)) +
geom_line(linewidth = 1) +
geom_point(size = 2) +
geom_errorbar(aes(ymin = prop_high_effort - se,
ymax = prop_high_effort + se), width = 0.1) +
facet_wrap(~ target) +
scale_color_manual(values = c("positive_norm" = "#59A14F",
"negative_norm" = "#E15759",
"control" = "#4E79A7"),
labels = c("Positive Norm", "Negative Norm", "Control")) +
labs(x = "Block", y = "Proportion High-Effort Choices",
color = "Condition",
title = "High-Effort Choice by Target, Block, and Norm Condition") +
theme(legend.position = "bottom")
p_main
# Interactions
# 1) per-participant proportions
summary_ppn <- df_long |>
group_by(ppn, target, group, block) |>
summarise(prop_per_ppn = mean(choice, na.rm = TRUE), .groups = "drop")
# 2) group means ± SE
summary_data <- summary_ppn |>
group_by(target, group, block) |>
summarise(
N  = n(),
M  = mean(prop_per_ppn, na.rm = TRUE),
SE = sd(prop_per_ppn, na.rm = TRUE) / sqrt(N),
.groups = "drop"
)
pd <- position_dodge(width = 0.00)  # no horizontal dodging (lines connect same x)
ggplot(summary_data,
aes(x = block, y = M, color = group, group = group)) +
geom_line(linewidth = 1.1, position = pd) +
geom_point(size = 3, position = pd) +
facet_wrap(~ target, labeller = labeller(
target = c(self="Self", climate="Climate", prosocial="Prosocial")
)) +
scale_color_manual(
values = c("control" = "#4E79A7",
"positive_norm" = "#1B9E77",  # darker green for contrast
"negative_norm" = "#D95F02"),
labels = c("Control", "Positive Norm", "Negative Norm"),
name   = "Condition"
) +
# zoom instead of clipping: keeps full error bars visible
scale_y_continuous(
labels = scales::percent_format(accuracy = 1),
limits = c(0, 1),
expand = expansion(mult = c(0, 0.02))
) +
labs(x = "Block",
y = "Proportion of High-Effort Choices",
title = "Observed Interaction: Target × Group × Block") +
theme_minimal(base_size = 13) +
theme(
legend.position = "top",
legend.title = element_text(),
panel.grid.minor = element_blank()
)
# Baseline model (intercept only)
m0 <- glmer(
choice ~ (1 | ppn) + (1 | class),
data = df_long, family = binomial, control = ctrl
)
# Step 1: Test whether classroom random intercept is needed
m1 <- glmer(
choice ~ target*group*block + reward*effort + school +
(1 | ppn) + (1 | class),
data = df_long, family = binomial, control = ctrl
)
m1_simpler <- glmer(
choice ~ target*group*block + reward*effort + school +
(1 | ppn),
data = df_long, family = binomial, control = ctrl
)
# Compare models
print(anova(m1_simpler, m1, test = "Chisq"))
print(isSingular(m1))
print(VarCorr(m1))
# Step 2: Add random slope for Block
m_full <- glmer(
choice ~ target*group*block + reward*effort + school +
(1 + block | ppn),
data = df_long, family = binomial, control = ctrl
)
# Compare models
print(anova(m1_simpler, m_full, test = "Chisq")) # full model is better
isSingular(m_full)
print(VarCorr(m_full))
# Step 3: test the 3-way interaction
m_no_3way <- glmer(
choice ~ target + group + block +
target:group + target:block + group:block +  # all 2-way interactions
reward * effort + school +
(1 + block | ppn),
data = df_long, family = binomial, control = ctrl
)
anova(m_no_3way, m_full, test = "Chisq") # model without 3way is better
# Choose final model
final_model <- m_full
summary(full_model)
summary(final_model)
# Overall model fit
print(anova(m0, final_model, test = "Chisq"))
# Odds ratio with 95% CIs
se <- sqrt(diag(vcov(final_model)))
log_odds <- fixef(final_model)
tab <- data.frame(
OR = exp(log_odds),
LL = exp(log_odds - 1.96 * se),
UL = exp(log_odds + 1.96 * se)
)
print(round(tab, 3))
coefs <- summary(final_model)$ coefficients[, "Estimate"]
std.err <- summary(final_model)$ coefficients[, "Std. Error"]
nams <- rownames(summary(final_model)$ coefficients)
# 1. EMM for all combinations of reward x effort
emm_re <- emmeans(final_model, ~ reward * effort, type = "response")
# 2. Pairwise comparisons
# Reward effects within each effort level: Do high rewards increase choice probability equally at 40% and 90% effort?
contrast(emm_re, "pairwise", by = "effort", adjust = "holm")
# Effort effects within each reward level: Is 90% chosen less often than 40% at each reward magnitude?
contrast(emm_re, "pairwise", by = "reward", adjust = "holm")
# Visualization
emmip(final_model, effort ~ reward, CIs = TRUE, type = "response") +
labs(title = "Predicted Probability of High-Effort Choice",
y = "P(High-Effort Choice)",
x = "Reward (points)")
# 1. EMM for all combinations of target x group
emm_tg <- emmeans(final_model, ~ target * group, type = "response")
# 2. Pairwise comparisons
# Target differences within each group: Do groups differ in how they respond to Self vs Climate vs Prosocial cues?
contrast(emm_tg, "pairwise", by = "group", adjust = "holm")
# Group differences within each target: Do the norm groups differ in climate choices overall (pre+post averaged)?
contrast(emm_tg, "pairwise", by = "target", adjust = "holm")
# Visualization
emmip(emm_tg, group ~ target, CIs = TRUE, type = "response") +
labs(title = "Predicted Probability of High-Effort Choice",
y = "P(High-Effort Choice)",
x = "Social Target")
# EMM for the full 3 way interaction
emm_tgb <- emmeans(m_full, ~ target * group * block, type = "response")
emm_tgb
# Pre-to-Post changes within each target × group combination
prepost_tgb <- contrast(emm_tgb, method="revpairwise", by = c("target","group"),
type = "response")
# Difference-in-Differences: Compare pre-post changes across groups for each target
did_by_target <- contrast(
emm_tgb,
interaction = c("pairwise", "revpairwise"),  # group pairwise, block revpairwise
by = "target",
adjust = "holm",
type = "response"
)
print(did_by_target)
# Visualization
emmip(final_model, group ~ block | target, type = "response", CIs = TRUE) +
labs(title = "Predicted Probability of High-Effort Choice",
y = "P(High-Effort Choice)",
x = "Block")
# Create a summary of the DID analysis for easy reporting
did_summary <- as.data.frame(did_by_target)
print(did_summary)
