---
title: "3_analysis"
author: "Milena Costa"
date: "2025-11-03"
output: pdf_document
---

```{r setup, include=FALSE}

source(here::here("R","_common.R"), local = knitr::knit_global())

# Load processed data written by 1_dataprep

df_wide <- readRDS(here::here("data","processed","df_wide.rds"))
df_long <- readRDS(here::here("data","processed","df_long.rds"))


# set options
options(contrasts=c("contr.treatment", "contr.poly"))

# Control
ctrl <- glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e6))


```

# Statistical Analysis

## Research Question 1 (lme4)

```{r}

# Step 1: Test whether classroom random intercept is needed

m1 <- glmer(
  choice ~ target*group*block + reward*effort + school +
    (1 | ppn) + (1 | class),
  data = df_long, family = binomial, control = ctrl
)

m1_simpler <- glmer(
  choice ~ target*group*block + reward*effort + school +
    (1 | ppn),
  data = df_long, family = binomial, control = ctrl
)

# Compare models
print(anova(m1_simpler, m1, test = "Chisq"))
print(isSingular(m1))
print(VarCorr(m1))



# Step 2: Add random slope for Block
m2 <- glmer(
  choice ~ target*group*block + reward*effort + school +
    (1 + block | ppn),
  data = df_long, family = binomial, control = ctrl
)

# Compare models

print(anova(m1_simpler, m2, test = "Chisq")) # model 2 is better
cat("\nIs m2 singular? ", isSingular(m2), "\n")
print(VarCorr(m2))

# Choose final model 
final_model <- m2


print(summary(final_model))

# Fixed Effects

print(Anova(final_model, type = 3))

```

### Post-hoc Analyses 

```{r}


# --- Reward x effort --- 

emm_re <- emmeans(final_model, ~ reward * effort, type = "response")

print(summary(contrast(emm_re, "pairwise", by = "effort", adjust = "holm"),
infer = TRUE, type = "response"))
print(summary(contrast(emm_re, "pairwise", by = "reward", adjust = "holm"),
infer = TRUE, type = "response"))

emmip(final_model, effort ~ reward, CIs = TRUE, type = "response") # plot


# --- Target x group --- 

emm_tg <- emmeans(final_model, ~ target * group, type = "response")

print(summary(contrast(emm_tg, "pairwise", by = "group", adjust = "holm"),
infer = TRUE, type = "response"))
print(summary(contrast(emm_tg, "pairwise", by = "target", adjust = "holm"),
infer = TRUE, type = "response"))

emmip(emm_tg, group ~ target, CIs = TRUE) # plot


# Block x Target x Group (Difference-in-Differences)

# Get all EMMs

emm_all <- emmeans(final_model, ~ target * group * block, type = "response")
print(emm_all)

# Calculate pre-post differences

emm_by_block <- emmeans(final_model, ~ block | target * group, type = "response")
post_pre <- contrast(emm_by_block, method = "revpairwise")
print(post_pre)

# Compare pre-post changes between groups (difference-in-differences)

did_groups <- pairs(post_pre, by = "target", adjust = "holm")
print(did_groups)

# Focus on climate trials

climate_delta <- subset(post_pre, target == "climate")
print(climate_delta)
print(pairs(climate_delta, adjust = "holm"))

emmip(final_model, group ~ block | target, CIs = TRUE, type = "response") # plot


```

### Diagnostics (final_model)

```{r}

set.seed(123)
res <- simulateResiduals(final_model, n = 1000)
plot(res)
testUniformity(res)
testDispersion(res)
testZeroInflation(res)
testOutliers(res)

print(VarCorr(final_model))
print(performance::icc(final_model))
print(performance::check_collinearity(final_model))


```

## Research Question 2 (glmmTMB) 


```{r}


# Baseline model (no moderators)
m_baseline <- glmmTMB(
  choice ~ target*group*block + reward*effort + school +
    (1 + block | ppn),
  data = df_long, family = binomial
)

# Add susceptibility (main effect)
m_susceptibility <- glmmTMB(
  choice ~ target*group*block + reward*effort + school +
    susceptibility_c + 
    (1 + block | ppn),
  data = df_long, family = binomial
)

# Add cohesion (main effect)
m_cohesion <- glmmTMB(
  choice ~ target*group*block + reward*effort + school +
    susceptibility_c + cohesion_c + 
    (1 + block | ppn),
  data = df_long, family = binomial
)

# Moderator 1: susceptibility × group
m_suscept_mod <- glmmTMB(
  choice ~ target*group*block + reward*effort + school +
    susceptibility_c*group + cohesion_c +
    (1 + block | ppn),
  data = df_long, family = binomial
)

# Moderator 2: cohesion × group
m_cohesion_mod <- glmmTMB(
  choice ~ target*group*block + reward*effort + school +
    susceptibility_c*group + cohesion_c*group +
    (1 + block | ppn),
  data = df_long, family = binomial
)

# Compare model fits
anova(m_baseline, m_susceptibility, m_cohesion, 
      m_suscept_mod, m_cohesion_mod)

# Choose the best model
final_mod_model <- m_suscept_mod
summary(final_mod_model)

# Fixed effects

car::Anova(final_mod_model, type = 3)



```

### Analysis of Moderators 

```{r}

# Simple slopes of susceptibility per group

slopes <- emtrends(final_mod_model, ~ group, var = "susceptibility_c")
print(summary(slopes))
print(pairs(slopes, adjust = "holm"))

# Group differences at low/mean/high susceptibility

emm_susc_giv_s <- emmeans(
final_mod_model, ~ group | susceptibility_c,
at = list(susceptibility_c = c(-1, 0, 1)), type = "response"
)
print(summary(emm_susc_giv_s))
print(pairs(emm_susc_giv_s, by = "susceptibility_c", adjust = "holm"))

# Predicted probabilities across susceptibility per group

emm_susc <- emmeans(
final_mod_model, ~ susceptibility_c | group,
at = list(susceptibility_c = seq(-2, 2, by = 0.5)), type = "response"
)


emmip(final_mod_model, group ~ susceptibility_c,
at = list(susceptibility_c = seq(-2, 2, by = 0.5)),
type = "response") +
labs(title = "Group × Susceptibility", x = "Susceptibility (centered)", y = "Predicted probability") +
theme_minimal() # plot


```

### Model Diagnostics RQ2

```{r}


# Simulate residuals
res2 <- simulateResiduals(final_mod_model, n = 1000)
plot(res2)
testUniformity(res2)
testDispersion(res2)
testZeroInflation(res2)
testOutliers(res2)

# Variance components
VarCorr(final_mod_model)

# ICC
icc_vals <- performance::icc(final_mod_model)
icc_vals

# VIF / collinearity
performance::check_collinearity(final_mod_model)

```

### Exploratory Analyses

```{r}
# Filter to climate trials only
df_climate <- filter(df_long, target == "climate")

# Susceptibility × Group × Block (Climate Only)
m_H1 <- glmmTMB(
  choice ~ group * block * susceptibility_c + reward * effort + school +
    (1 + block | ppn),
  data = df_climate, 
  family = binomial
)


print(Anova(m_H1, type = 3))

print(summary(m_H1))

# Cohesion × Target × Group 
m_H2 <- glmmTMB(
  choice ~ target * group * block + reward * effort + school +
    cohesion_c * target * group +
    (1 + block | ppn),
  data = df_long, 
  family = binomial
)


print(Anova(m_H2, type = 3))




```

