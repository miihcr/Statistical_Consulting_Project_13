---
title: "3_analysis"
author: "Milena Costa"
date: "2025-11-03"
output: pdf_document
---

```{r setup, include=FALSE}

source(here::here("R","_common.R"), local = knitr::knit_global())

# Load processed data written by 1_dataprep

df_wide <- readRDS(here::here("data","processed","df_wide.rds"))
df_long <- readRDS(here::here("data","processed","df_long.rds"))


```

# Statistical Analysis

## Modelling Strategy

```{r}

# Control
ctrl <- glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e6))

## --- Random intercepts: ppn + class vs ppn only ---
m1 <- glmer(
  choice ~ target*group*block + reward*effort + school +
    (1 | ppn) + (1 | class),
  data = df_long, family = binomial, control = ctrl
)

isSingular(m1)
VarCorr(m1)

m1_simpler <- glmer(
  choice ~ target*group*block + reward*effort + school +
    (1 | ppn),
  data = df_long, family = binomial, control = ctrl
)

anova(m1_simpler, m1, test = "Chisq")

# --- Add slopes (|) ---
m2 <- glmer(
  choice ~ target*group*block + reward*effort + school +
    (1 + block | ppn),
  data = df_long, family = binomial, control = ctrl
)

isSingular(m2)
VarCorr(m2)
anova(m1_simpler, m2, test = "Chisq")

final_model <- m2

Anova(final_model, type = 3)
summary(final_model)


```

## Model Diagnostics

```{r}


# Simulate residuals
res <- simulateResiduals(final_model)
plot(res)
testUniformity(res)
testDispersion(res)
testZeroInflation(res)
testOutliers(res)

# Variance components
VarCorr(final_model)

# ICC
icc_vals <- performance::icc(final_model)
icc_vals

# VIF / collinearity
performance::check_collinearity(final_model)

```




## Estimated Marginal Means & Contrasts

```{r}


# --- a) Predicted probabilities  
emm_all <- emmeans(final_model, ~ target * group * block, type = "response")
emm_all

# --- b) Post - Pre within each (target x group)
emm_by_block <- emmeans(final_model, ~ block | target * group, type = "response")
post_pre     <- contrast(emm_by_block, method = "revpairwise")  # Post - Pre
post_pre

# --- c) Compare Post-Pre deltas across groups, separately by target
did_groups <- pairs(post_pre, by = "target", adjust = "holm")
did_groups

# --- d) Climate only change and between group comparisons
climate_delta <- subset(post_pre, target == "climate")
climate_delta
pairs(climate_delta, adjust = "holm")

# --- e) Plot with CIs
emmip(final_model, group ~ block | target, CIs = TRUE, type = "response")

```

## Model with the Moderators

Note: We initially fitted the moderator models using glmer, but the computations took too long. Therefore, we used glmmTMB, which is more efficient for complex models.

```{r}

# Baseline model (no moderators)
m_baseline <- glmmTMB(
  choice ~ target*group*block + reward*effort + school +
    (1 + block | ppn),
  data = df_long, family = binomial
)

# Add susceptibility (main effect only)
m_susceptibility <- glmmTMB(
  choice ~ target*group*block + reward*effort + school +
    susceptibility_c + 
    (1 + block | ppn),
  data = df_long, family = binomial
)

# Add cohesion (main effect only)
m_cohesion <- glmmTMB(
  choice ~ target*group*block + reward*effort + school +
    susceptibility_c + cohesion_c + 
    (1 + block | ppn),
  data = df_long, family = binomial
)

# Moderator 1: susceptibility × group
m_suscept_mod <- glmmTMB(
  choice ~ target*group*block + reward*effort + school +
    susceptibility_c*group + cohesion_c +
    (1 + block | ppn),
  data = df_long, family = binomial
)

# Moderator 2: cohesion × group
m_cohesion_mod <- glmmTMB(
  choice ~ target*group*block + reward*effort + school +
    susceptibility_c*group + cohesion_c*group +
    (1 + block | ppn),
  data = df_long, family = binomial
)

# Compare model fits
anova(m_baseline, m_susceptibility, m_cohesion, 
      m_suscept_mod, m_cohesion_mod)

# Keep the better-fitting moderator model
final_mod_model <- m_suscept_mod
summary(final_mod_model)
car::Anova(final_mod_model, type = 3)


```

# Analysis of Moderators

```{r}


# --- Slopes of susceptibility per group ---

slopes <- emtrends(final_mod_model, ~ group, var = "susceptibility_c")
summary(slopes)
pairs(slopes, adjust = "holm")  # test if slopes differ



# --- Predicted probabilities at low/mean/high susceptibility

emm_suscept <- emmeans(final_mod_model, 
                       ~ group | susceptibility_c,
                       at = list(susceptibility_c = c(-1, 0, 1)),
                       type = "response")

summary(emm_suscept)
pairs(emm_suscept, by = "susceptibility_c", adjust = "holm")

# Visualization
emmip(final_mod_model, group ~ susceptibility_c,
      at = list(susceptibility_c = seq(-2, 2, by = 0.5)),
      type = "response") +
  labs(
    title = "Group × Susceptibility Interaction",
    x = "Social Susceptibility (centered)",
    y = "Predicted Probability"
  ) +
  theme_minimal()



# Hypothesis 1: Social Susceptibility in Climate Trials

df_climate <- df_long |> filter(target == "climate")

m_H1 <- glmmTMB(
  choice ~ group * block * susceptibility_c + reward * effort + school +
    (1 + block | ppn),
  data = df_climate,
  family = binomial
)

summary(m_H1)
car::Anova(m_H1, type = 3)

# 3-way interaction non-significant 

# Hypothesis 2: Social Cohesion

m_H2 <- glmmTMB(
  choice ~ target * group * block + reward * effort + school +
    cohesion_c * target * group +
    (1 + block | ppn),
  data = df_long,
  family = binomial
)

summary(m_H2)
car::Anova(m_H2, type = 3)



# Climate trials

emm_climate <- emmeans(
  m_H2,
  ~ group | cohesion_c,
  at = list(
    target = "climate",
    cohesion_c = c(-1, 0, 1)
  ),
  type = "response"
)

diff_climate <- contrast(
  emm_climate,
  method = "pairwise",
  by = "cohesion_c",
  adjust = "holm"
)
summary(diff_climate)


emmip(m_H2, group ~ cohesion_c | target,
      at = list(cohesion_c = c(-1,0,1)),
      type = "response") +
  labs(
    title = "H2: Cohesion × Group × Target",
    x = "Social Cohesion (centered)",
    y = "Predicted Probability of Climate Choice"
  ) +
  theme_minimal()



```

