"0","
# --- 1. Import data ---
df_wide <- read.csv(here(""data"", ""raw"", ""data_2.csv""))
head(df_wide)
"
"0",""
"0","# --- 2. Ensure factors ---"
"0","df_wide <- df_wide |>"
"0","  mutate("
"0","    ppn = as.factor(ppn),"
"0","    school = factor(school, levels = c(1, 2, 3)),"
"0","    class = factor(class),"
"0","    group = factor(group, levels = c(1, 2, 3),"
"0","                   labels = c(""high_norm"", ""low_norm"", ""control""))"
"0","  )"
"0",""
"0","# --- 3. Define SUS item groups ---"
"0","sus_items      <- paste0(""SUS_"", 1:8)"
"0","sus_anx_items  <- c(""SUS_1"", ""SUS_3"", ""SUS_5"", ""SUS_7"")"
"0","sus_peer_items <- c(""SUS_2"", ""SUS_4"", ""SUS_6"", ""SUS_8"")"
"0",""
"0","# --- 4. Convert SUS items to numeric and impute missing values ---"
"0","df_wide <- df_wide |>"
"0","  mutate(across(all_of(sus_items), ~ suppressWarnings(as.numeric(.x))))"
"0",""
"0","# Person-mean imputation"
"0","sus_mat <- as.matrix(df_wide[, sus_items, drop = FALSE])"
"0","row_means <- rowMeans(sus_mat, na.rm = TRUE)"
"0",""
"0","for (j in seq_along(sus_items)) {"
"0","  idx <- is.na(sus_mat[, j])"
"0","  sus_mat[idx, j] <- row_means[idx]"
"0","}"
"0","df_wide[, sus_items] <- sus_mat"
"0",""
"0","# Compute subscale scores"
"0","df_wide <- df_wide |>"
"0","  mutate("
"0","    SUS_social_anxiety    = rowMeans(across(all_of(sus_anx_items))),"
"0","    SUS_peers_self_esteem = rowMeans(across(all_of(sus_peer_items))),"
"0","    SUS_total             = rowMeans(across(all_of(sus_items))),"
"0","    SUS_total_c           = SUS_total - mean(SUS_total, na.rm = TRUE)"
"0","  )"
"0",""
"0","# --- 5. Identify trial columns ---"
"0","trial_pattern <- ""^(X)?[12]_(SELF|CLIMATE|OTHERS)_(2|6|10)(easy|hard)(40|90)$"""
"0","trial_cols <- names(select(df_wide, matches(trial_pattern)))"
"0",""
"0","# --- 6. Reshape to long format ---"
"0","df_long <- df_wide |>"
"0","  pivot_longer("
"0","    cols = all_of(trial_cols),"
"0","    names_to = ""trial"","
"0","    values_to = ""choice_raw"""
"0","  ) |>"
"0","  mutate("
"0","    trial_clean = str_remove(trial, ""^X""),"
"0","    block_num   = as.integer(str_extract(trial_clean, ""^[12]"")),"
"0","    target_raw  = str_extract(trial_clean, ""(SELF|CLIMATE|OTHERS)""),"
"0","    reward_num  = as.integer(str_extract(trial_clean, ""(?<=_)\\d{1,2}(?=(easy|hard))"")),"
"0","    effort_raw  = as.integer(str_extract(trial_clean, ""(40|90)$"")),"
"0",""
"0","    # Final labeled variables"
"0","    block  = factor(block_num, levels = c(1, 2), labels = c(""pre"", ""post"")),"
"0","    target = factor(target_raw,"
"0","                    levels = c(""SELF"", ""CLIMATE"", ""OTHERS""),"
"0","                    labels = c(""self"", ""climate"", ""prosocial"")),"
"0","    effort = factor(effort_raw, levels = c(40, 90), labels = c(""40"", ""90"")),"
"0","    reward = factor(reward_num, levels = c(2, 6, 10), ordered = TRUE),"
"0",""
"0","    choice = case_when("
"0","      choice_raw == 1 ~ 1L,  # high-effort choice"
"0","      choice_raw == 2 ~ 0L,  # low-effort choice"
"0","      TRUE ~ NA_integer_"
"0","    ),"
"0",""
"0","    trial = trial_clean"
"0","  ) |>"
"0","  select(ppn, school, class, group,"
"0","         trial, block, target, reward, reward_num,effort, "
"0","         choice, SUS_social_anxiety, "
"0","         SUS_peers_self_esteem, SUS_total, SUS_total_c) |>"
"0","  mutate("
"0","    # Reference coding for contrasts"
"0","    group  = relevel(group, ref = ""control""),"
"0","    target = relevel(target, ref = ""self""),"
"0","    effort = relevel(effort, ref = ""40""),"
"0","    block  = relevel(block,  ref = ""pre""),"
"0","  )"
"0",""
"0","# --- 7. Checks ---"
"0","# Check structure"
"0","glimpse(df_long)"
"1","Rows: 5,904"
"1",""
"1","
"
"1","Columns: 15"
"1",""
"1","
"
"1","$ ppn                   <fct> 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2…
$ school                <fct> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ class                 <fct> 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6…
$ group                 <fct> low_norm, low_norm, low_norm, low_nor…
$ trial                 <chr> ""1_SELF_2easy40"", ""1_SELF_6easy40"", ""…
$ block                 <fct> pre, pre, pre, pre, pre, pre, pre, pr…
$ target                <fct> self, self, self, self, self, self, c…
$ reward                <ord> 2, 6, 10, 2, 6, 10, 2, 6, 10, 2, 6, 1…
$ reward_num            <int> 2, 6, 10, 2, 6, 10, 2, 6, 10, 2, 6, 1…
$ effort                <fct> 40, 40, 40, 90, 90, 90, 40, 40, 40, 9…
$ choice                <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ SUS_social_anxiety    <dbl> 1.75, 1.75, 1.75, 1.75, 1.75, 1.75, 1…
$ SUS_peers_self_esteem <dbl> 1.75, 1.75, 1.75, 1.75, 1.75, 1.75, 1…
$ SUS_total             <dbl> 1.75, 1.75, 1.75, 1.75, 1.75, 1.75, 1…
$ SUS_total_c           <dbl> -0.7982595, -0.7982595, -0.7982595, -…"
"1",""
"1","
"
"0","# Balanced design?"
"0","table(df_long$group, df_long$block)"
"1","           
"
"1","           "
"1","  pre"
"1"," post"
"1","
  control  "
"1"," 1008"
"1"," 1008"
"1","
  high_norm"
"1","  990"
"1","  990"
"1","
  low_norm "
"1","  954"
"1","  954"
"1","
"
"0","table(df_long$target, df_long$block)"
"1","           
"
"1","           "
"1"," pre"
"1"," post"
"1","
  self     "
"1"," 984"
"1","  984"
"1","
  climate  "
"1"," 984"
"1","  984"
"1","
  prosocial"
"1"," 984"
"1","  984"
"1","
"
"0","# Missing data"
"0","colSums(is.na(df_long))"
"1","                  ppn "
"1","               school "
"1","                class "
"1","
"
"1","                    0 "
"1","                    0 "
"1","                    0 "
"1","
"
"1","                group "
"1","                trial "
"1","                block "
"1","
"
"1","                    0 "
"1","                    0 "
"1","                    0 "
"1","
"
"1","               target "
"1","               reward "
"1","           reward_num "
"1","
"
"1","                    0 "
"1","                    0 "
"1","                    0 "
"1","
"
"1","               effort "
"1","               choice "
"1","   SUS_social_anxiety "
"1","
"
"1","                    0 "
"1","                   28 "
"1","                  216 "
"1","
"
"1","SUS_peers_self_esteem "
"1","            SUS_total "
"1","          SUS_total_c "
"1","
"
"1","                  216 "
"1","                  216 "
"1","                  216 "
"1","
"
"0","# Check outcome coding (should be mostly 1s, some 0s)"
"0","prop.table(table(df_long$choice))"
"1","
"
"1","         0 "
"1","         1 "
"1","
"
"1","0.07641253 "
"1","0.92358747 "
"1","
"
