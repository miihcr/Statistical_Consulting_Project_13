
# Baseline model (no moderators)
m_baseline <- glmmTMB(
  choice ~ target*group*block + reward*effort + school +
    (1 + block | ppn),
  data = df_long, family = binomial
)

# Add susceptibility (main effect only)
m_susceptibility <- glmmTMB(
  choice ~ target*group*block + reward*effort + school +
    susceptibility_c + 
    (1 + block | ppn),
  data = df_long, family = binomial
)

# Add cohesion (main effect only)
m_cohesion <- glmmTMB(
  choice ~ target*group*block + reward*effort + school +
    susceptibility_c + cohesion_c + 
    (1 + block | ppn),
  data = df_long, family = binomial
)

# Moderator 1: susceptibility × group
m_suscept_mod <- glmmTMB(
  choice ~ target*group*block + reward*effort + school +
    susceptibility_c*group + cohesion_c +
    (1 + block | ppn),
  data = df_long, family = binomial
)

# Moderator 2: cohesion × group
m_cohesion_mod <- glmmTMB(
  choice ~ target*group*block + reward*effort + school +
    susceptibility_c*group + cohesion_c*group +
    (1 + block | ppn),
  data = df_long, family = binomial
)

# Compare model fits
anova(m_baseline, m_susceptibility, m_cohesion, 
      m_suscept_mod, m_cohesion_mod)

# Keep the better-fitting moderator model
final_mod_model <- m_suscept_mod
summary(final_mod_model)
car::Anova(final_mod_model, type = 3)




# --- Slopes of susceptibility per group ---

slopes <- emtrends(final_mod_model, ~ group, var = "susceptibility_c")
summary(slopes)
pairs(slopes, adjust = "holm")  # test if slopes differ



# --- Predicted probabilities at low/mean/high susceptibility

emm_suscept <- emmeans(final_mod_model, 
                       ~ group | susceptibility_c,
                       at = list(susceptibility_c = c(-1, 0, 1)),
                       type = "response")

summary(emm_suscept)
pairs(emm_suscept, by = "susceptibility_c", adjust = "holm")

# Visualization
emmip(final_mod_model, group ~ susceptibility_c,
      at = list(susceptibility_c = seq(-2, 2, by = 0.5)),
      type = "response") +
  labs(
    title = "Group × Susceptibility Interaction",
    x = "Social Susceptibility (centered)",
    y = "Predicted Probability"
  ) +
  theme_minimal()



# Hypothesis 1: Social Susceptibility in Climate Trials

df_climate <- df_long |> filter(target == "climate")

m_H1 <- glmmTMB(
  choice ~ group * block * susceptibility_c + reward * effort + school +
    (1 + block | ppn),
  data = df_climate,
  family = binomial
)

summary(m_H1)
car::Anova(m_H1, type = 3)

# 3-way interaction non-significant 

# Hypothesis 2: Social Cohesion

m_H2 <- glmmTMB(
  choice ~ target * group * block + reward * effort + school +
    cohesion_c * target * group +
    (1 + block | ppn),
  data = df_long,
  family = binomial
)

summary(m_H2)
car::Anova(m_H2, type = 3)



# Climate trials

emm_climate <- emmeans(
  m_H2,
  ~ group | cohesion_c,
  at = list(
    target = "climate",
    cohesion_c = c(-1, 0, 1)
  ),
  type = "response"
)

diff_climate <- contrast(
  emm_climate,
  method = "pairwise",
  by = "cohesion_c",
  adjust = "holm"
)
summary(diff_climate)


emmip(m_H2, group ~ cohesion_c | target,
      at = list(cohesion_c = c(-1,0,1)),
      type = "response") +
  labs(
    title = "H2: Cohesion × Group × Target",
    x = "Social Cohesion (centered)",
    y = "Predicted Probability of Climate Choice"
  ) +
  theme_minimal()

