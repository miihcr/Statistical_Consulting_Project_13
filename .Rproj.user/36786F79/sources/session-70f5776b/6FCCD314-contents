# Hypothesis 1: group × block × susceptibility for climate

df_climate <- df_long |> filter(target == "climate")

m_H1 <- glmmTMB(
  choice ~ group * block * susceptibility_c + reward * effort + school +
    (1 + block | ppn),
  data = df_climate,   # climate trials only
  family = binomial
)

summary(m_H1)
car::Anova(m_H1, type = 3)

# Hypothesis 1: not significant


# Hypothesis 2: cohesion × target × manipulation

m_H2 <- glmmTMB(
  choice ~ target * group * block + reward * effort + school +
    cohesion_c * target * group +  # key hypothesis
    (1 + block | ppn),
  data = df_long,
  family = binomial
)

summary(m_H2)

# Estimated marginal means by group, within climate target, across cohesion levels
emm_climate <- emmeans(
  m_H2,
  ~ group | cohesion_c,
  at = list(
    target = "climate",
    cohesion_c = c(-1, 0, 1)  # low / mean / high (1 SD units)
  ),
  type = "response"
)

# Pairwise difference (positive_norm – control) at each cohesion level
diff_climate <- contrast(
  emm_climate,
  method = "pairwise",
  by = "cohesion_c",
  adjust = "holm"
)

summary(diff_climate)




# --- Slopes of susceptibility per group ---

slopes <- emtrends(final_mod_model, ~ group, var = "susceptibility_c")
summary(slopes)
pairs(slopes, adjust = "holm")  # test if slopes differ



# --- Predicted probabilities at low/mean/high susceptibility

emm_suscept <- emmeans(final_mod_model, 
                       ~ group | susceptibility_c,
                       at = list(susceptibility_c = c(-1, 0, 1)),
                       type = "response")

summary(emm_suscept)
pairs(emm_suscept, by = "susceptibility_c", adjust = "holm")

# Visualization
emmip(final_mod_model, group ~ susceptibility_c,
      at = list(susceptibility_c = seq(-2, 2, by = 0.5)),
      type = "response") +
  labs(
    title = "Group × Susceptibility Interaction",
    x = "Social Susceptibility (centered)",
    y = "Predicted Probability"
  ) +
  theme_minimal()



# Hypothesis 1: Social Susceptibility in Climate Trials

df_climate <- df_long |> filter(target == "climate")

m_H1 <- glmmTMB(
  choice ~ group * block * susceptibility_c + reward * effort + school +
    (1 + block | ppn),
  data = df_climate,
  family = binomial
)

summary(m_H1)
car::Anova(m_H1, type = 3)

# 3-way interaction non-significant 

# Hypothesis 2: Social Cohesion

m_H2 <- glmmTMB(
  choice ~ target * group * block + reward * effort + school +
    cohesion_c * target * group +
    (1 + block | ppn),
  data = df_long,
  family = binomial
)

summary(m_H2)
car::Anova(m_H2, type = 3)



# Climate trials

emm_climate <- emmeans(
  m_H2,
  ~ group | cohesion_c,
  at = list(
    target = "climate",
    cohesion_c = c(-1, 0, 1)
  ),
  type = "response"
)

diff_climate <- contrast(
  emm_climate,
  method = "pairwise",
  by = "cohesion_c",
  adjust = "holm"
)
summary(diff_climate)


emmip(m_H2, group ~ cohesion_c | target,
      at = list(cohesion_c = c(-1,0,1)),
      type = "response") +
  labs(
    title = "H2: Cohesion × Group × Target",
    x = "Social Cohesion (centered)",
    y = "Predicted Probability of Climate Choice"
  ) +
  theme_minimal()


emmip(final_mod_model, group ~ susceptibility_c,
      at = list(susceptibility_c = seq(-2, 2, by = 0.5)),
      type = "response") +
  labs(
    title = "H1: Group × Susceptibility (Climate Trials)",
    x = "Social Susceptibility (centered)",
    y = "Predicted Probability of Climate Choice"
  ) +
  theme_minimal()


emmip(m_H2, group ~ cohesion_c | target,
      at = list(cohesion_c = seq(-2, 2, by = 0.5)),
      type = "response") +
  labs(
    title = "H2: Cohesion × Group × Target",
    x = "Social Cohesion (centered)",
    y = "Predicted Probability of Choice"
  ) +
  theme_minimal()
