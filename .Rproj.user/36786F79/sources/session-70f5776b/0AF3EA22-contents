# Control
ctrl <- glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e6))

## --- Random intercepts: ppn + class vs ppn only ---
m1 <- glmer(
  choice ~ target*group*block + reward*effort + school +
    (1 | ppn) + (1 | class),
  data = df_long, family = binomial, control = ctrl
)

isSingular(m1)
VarCorr(m1)

m1_simpler <- glmer(
  choice ~ target*group*block + reward*effort + school +
    (1 | ppn),
  data = df_long, family = binomial, control = ctrl
)

anova(m1_simpler, m1, test = "Chisq")

# --- Add slopes (|) ---
m2 <- glmer(
  choice ~ target*group*block + reward*effort + school +
    (1 + block | ppn),
  data = df_long, family = binomial, control = ctrl
)

isSingular(m2)
VarCorr(m2)
anova(m1_simpler, m2, test = "Chisq")

final_model <- m2

Anova(final_model, type = 3)
summary(final_model)

coefs <- summary(final_model)$coefficients

coefs[grep("^reward", rownames(coefs)), , drop = FALSE]



coefs[grep("^effort", rownames(coefs)), , drop = FALSE]


# --- a) Predicted probabilities  
emm_all <- emmeans(final_model, ~ target * group * block, type = "response")
emm_all

# --- b) Post - Pre within each (target x group)
emm_by_block <- emmeans(final_model, ~ block | target * group, type = "response")
post_pre     <- contrast(emm_by_block, method = "revpairwise")  # Post - Pre
post_pre

# --- c) Compare Post-Pre deltas across groups, separately by target
did_groups <- pairs(post_pre, by = "target", adjust = "holm")
did_groups

# --- d) Climate only change and between group comparisons
climate_delta <- subset(post_pre, target == "climate")
climate_delta
pairs(climate_delta, adjust = "holm")

# --- e) Plot with CIs
emmip(final_model, group ~ block | target, CIs = TRUE, type = "response")